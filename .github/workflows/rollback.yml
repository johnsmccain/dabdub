name: Rollback

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: true
        type: choice
        options:
          - staging
          - production
      image_tag:
        description: "Image tag to deploy (e.g. commit SHA)"
        required: true
        type: string

permissions:
  contents: read

env:
  IMAGE_NAME: ghcr.io/${{ github.repository }}-backend
  REGISTRY: ghcr.io

jobs:
  rollback:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    env:
      SSH_HOST: ${{ secrets.DEPLOY_HOST }}
      SSH_USER: ${{ secrets.DEPLOY_USER }}
      SSH_PORT: ${{ secrets.DEPLOY_PORT }}
      DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
      REGISTRY_USER: ${{ secrets.REGISTRY_USER }}
      REGISTRY_TOKEN: ${{ secrets.REGISTRY_TOKEN }}
      HEALTHCHECK_URL: ${{ secrets.HEALTHCHECK_URL }}
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      SMTP_HOST: ${{ secrets.SMTP_HOST }}
      SMTP_PORT: ${{ secrets.SMTP_PORT }}
      SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
      SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
      EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
      EMAIL_TO: ${{ secrets.EMAIL_TO }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Start SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Trust host key
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p "${SSH_PORT:-22}" -H "$SSH_HOST" >> ~/.ssh/known_hosts

      - name: Upload deployment assets
        run: |
          scp -P "${SSH_PORT:-22}" backend/docker-compose.yml scripts/deploy.sh \
            "${SSH_USER}@${SSH_HOST}:${DEPLOY_PATH}/"

      - name: Login to registry on server
        run: |
          ssh -p "${SSH_PORT:-22}" "${SSH_USER}@${SSH_HOST}" \
            "echo '${REGISTRY_TOKEN}' | docker login ${REGISTRY} -u '${REGISTRY_USER}' --password-stdin"

      - name: Deploy rollback image
        run: |
          ssh -p "${SSH_PORT:-22}" "${SSH_USER}@${SSH_HOST}" \
            "bash ${DEPLOY_PATH}/deploy.sh --image '${IMAGE_NAME}:${{ inputs.image_tag }}' --compose-file '${DEPLOY_PATH}/docker-compose.yml' --env-file '${DEPLOY_PATH}/.env' --project-name dabdub"

      - name: Health check
        run: scripts/healthcheck.sh "$HEALTHCHECK_URL"

      - name: Slack notification
        if: env.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {"text":"Rollback ${IMAGE_NAME}:${{ inputs.image_tag }} - ${GITHUB_REPOSITORY} - ${JOB_STATUS}"}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          JOB_STATUS: ${{ job.status }}

      - name: Email notification
        if: env.SMTP_HOST != ''
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ env.SMTP_HOST }}
          server_port: ${{ env.SMTP_PORT }}
          username: ${{ env.SMTP_USERNAME }}
          password: ${{ env.SMTP_PASSWORD }}
          subject: "Rollback: ${{ job.status }} - ${{ github.repository }}"
          to: ${{ env.EMAIL_TO }}
          from: ${{ env.EMAIL_FROM }}
          body: "Rollback to image tag ${{ inputs.image_tag }} completed with status: ${{ job.status }}."
