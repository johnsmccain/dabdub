name: Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  packages: write

env:
  IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}-backend
  REGISTRY: ghcr.io

jobs:
  build-image:
    runs-on: ubuntu-latest
    outputs:
      image: ${{ env.IMAGE_TAG_BASE }}:${{ github.sha }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Convert image name to lowercase
        run: |
          IMAGE_BASE=$(echo ghcr.io/${{ github.repository }}-backend | tr '[:upper:]' '[:lower:]')
          echo "IMAGE_TAG_BASE=${IMAGE_BASE}" >> $GITHUB_ENV

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push image
        uses: docker/build-push-action@v6
        with:
          context: backend
          file: backend/Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_TAG_BASE }}:${{ github.sha }}
            ${{ env.IMAGE_TAG_BASE }}:latest

  deploy-staging:
    runs-on: ubuntu-latest
    needs: build-image
    environment: staging
    env:
      SSH_HOST: ${{ secrets.DEPLOY_HOST }}
      SSH_USER: ${{ secrets.DEPLOY_USER }}
      SSH_PORT: ${{ secrets.DEPLOY_PORT }}
      DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
      REGISTRY_USER: ${{ secrets.REGISTRY_USER }}
      REGISTRY_TOKEN: ${{ secrets.REGISTRY_TOKEN }}
      HEALTHCHECK_URL: ${{ secrets.HEALTHCHECK_URL }}
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      SMTP_HOST: ${{ secrets.SMTP_HOST }}
      SMTP_PORT: ${{ secrets.SMTP_PORT }}
      SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
      SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
      EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
      EMAIL_TO: ${{ secrets.EMAIL_TO }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Start SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Trust host key
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p "${SSH_PORT:-22}" -H "$SSH_HOST" >> ~/.ssh/known_hosts

      - name: Upload deployment assets
        run: |
          scp -P "${SSH_PORT:-22}" backend/docker-compose.yml scripts/deploy.sh \
            "${SSH_USER}@${SSH_HOST}:${DEPLOY_PATH}/"

      - name: Login to registry on server
        run: |
          ssh -p "${SSH_PORT:-22}" "${SSH_USER}@${SSH_HOST}" \
            "echo '${REGISTRY_TOKEN}' | docker login ${REGISTRY} -u '${REGISTRY_USER}' --password-stdin"

      - name: Deploy staging
        run: |
          ssh -p "${SSH_PORT:-22}" "${SSH_USER}@${SSH_HOST}" \
            "bash ${DEPLOY_PATH}/deploy.sh --image '${{ needs.build-image.outputs.image }}' --compose-file '${DEPLOY_PATH}/docker-compose.yml' --env-file '${DEPLOY_PATH}/.env' --project-name dabdub"

      - name: Health check
        run: scripts/healthcheck.sh "$HEALTHCHECK_URL"

      - name: Slack notification
        if: env.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {"text":"Staging deploy ${GITHUB_SHA} - ${GITHUB_REPOSITORY} - ${JOB_STATUS}"}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          JOB_STATUS: ${{ job.status }}

      - name: Email notification
        if: env.SMTP_HOST != ''
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ env.SMTP_HOST }}
          server_port: ${{ env.SMTP_PORT }}
          username: ${{ env.SMTP_USERNAME }}
          password: ${{ env.SMTP_PASSWORD }}
          subject: "Staging deploy: ${{ job.status }} - ${{ github.repository }}"
          to: ${{ env.EMAIL_TO }}
          from: ${{ env.EMAIL_FROM }}
          body: "Staging deploy completed with status: ${{ job.status }} (commit ${{ github.sha }})."

  deploy-production:
    runs-on: ubuntu-latest
    needs: deploy-staging
    environment: production
    env:
      SSH_HOST: ${{ secrets.DEPLOY_HOST }}
      SSH_USER: ${{ secrets.DEPLOY_USER }}
      SSH_PORT: ${{ secrets.DEPLOY_PORT }}
      DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
      REGISTRY_USER: ${{ secrets.REGISTRY_USER }}
      REGISTRY_TOKEN: ${{ secrets.REGISTRY_TOKEN }}
      HEALTHCHECK_URL: ${{ secrets.HEALTHCHECK_URL }}
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      SMTP_HOST: ${{ secrets.SMTP_HOST }}
      SMTP_PORT: ${{ secrets.SMTP_PORT }}
      SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
      SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
      EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
      EMAIL_TO: ${{ secrets.EMAIL_TO }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Start SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Trust host key
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p "${SSH_PORT:-22}" -H "$SSH_HOST" >> ~/.ssh/known_hosts

      - name: Upload deployment assets
        run: |
          scp -P "${SSH_PORT:-22}" backend/docker-compose.yml scripts/deploy.sh \
            "${SSH_USER}@${SSH_HOST}:${DEPLOY_PATH}/"

      - name: Login to registry on server
        run: |
          ssh -p "${SSH_PORT:-22}" "${SSH_USER}@${SSH_HOST}" \
            "echo '${REGISTRY_TOKEN}' | docker login ${REGISTRY} -u '${REGISTRY_USER}' --password-stdin"

      - name: Deploy production
        run: |
          ssh -p "${SSH_PORT:-22}" "${SSH_USER}@${SSH_HOST}" \
            "bash ${DEPLOY_PATH}/deploy.sh --image '${{ needs.build-image.outputs.image }}' --compose-file '${DEPLOY_PATH}/docker-compose.yml' --env-file '${DEPLOY_PATH}/.env' --project-name dabdub"

      - name: Health check
        run: scripts/healthcheck.sh "$HEALTHCHECK_URL"

      - name: Slack notification
        if: env.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {"text":"Production deploy ${GITHUB_SHA} - ${GITHUB_REPOSITORY} - ${JOB_STATUS}"}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          JOB_STATUS: ${{ job.status }}

      - name: Email notification
        if: env.SMTP_HOST != ''
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ env.SMTP_HOST }}
          server_port: ${{ env.SMTP_PORT }}
          username: ${{ env.SMTP_USERNAME }}
          password: ${{ env.SMTP_PASSWORD }}
          subject: "Production deploy: ${{ job.status }} - ${{ github.repository }}"
          to: ${{ env.EMAIL_TO }}
          from: ${{ env.EMAIL_FROM }}
          body: "Production deploy completed with status: ${{ job.status }} (commit ${{ github.sha }})."
